{"version":3,"sources":["../../../../src/app/%28admin%29/stakeholders/actions.ts","../../../../.next-internal/server/app/%28admin%29/stakeholders/new/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["\"use server\";\n\nimport { prisma } from \"@/lib/prisma\";\nimport { revalidatePath } from \"next/cache\";\nimport { redirect } from \"next/navigation\";\nimport { z } from \"zod\";\n\nconst stakeholderSchema = z.object({\n  name: z.string().min(1, \"Name is required\"),\n  email: z.string().email(\"Valid email is required\"),\n  type: z.enum([\"FOUNDER\", \"EMPLOYEE\", \"INVESTOR\", \"ADVISOR\", \"BOARD_MEMBER\", \"CONSULTANT\"]),\n  title: z.string().optional(),\n});\n\nexport type StakeholderFormState = {\n  errors?: {\n    name?: string[];\n    email?: string[];\n    type?: string[];\n    title?: string[];\n    _form?: string[];\n  };\n  success?: boolean;\n};\n\nexport async function createStakeholder(\n  prevState: StakeholderFormState,\n  formData: FormData\n): Promise<StakeholderFormState> {\n  const company = await prisma.company.findFirst();\n  if (!company) {\n    return { errors: { _form: [\"No company found. Please create a company first.\"] } };\n  }\n\n  const validatedFields = stakeholderSchema.safeParse({\n    name: formData.get(\"name\"),\n    email: formData.get(\"email\"),\n    type: formData.get(\"type\"),\n    title: formData.get(\"title\") || undefined,\n  });\n\n  if (!validatedFields.success) {\n    return { errors: validatedFields.error.flatten().fieldErrors };\n  }\n\n  const { name, email, type, title } = validatedFields.data;\n\n  try {\n    // Check if stakeholder with this email already exists\n    const existing = await prisma.stakeholder.findUnique({\n      where: {\n        companyId_email: {\n          companyId: company.id,\n          email: email.toLowerCase(),\n        },\n      },\n    });\n\n    if (existing) {\n      return { errors: { email: [\"A stakeholder with this email already exists\"] } };\n    }\n\n    await prisma.stakeholder.create({\n      data: {\n        companyId: company.id,\n        name,\n        email: email.toLowerCase(),\n        type,\n        title: title || null,\n      },\n    });\n  } catch (error) {\n    console.error(\"Error creating stakeholder:\", error);\n    return { errors: { _form: [\"Failed to create stakeholder\"] } };\n  }\n\n  revalidatePath(\"/stakeholders\");\n  redirect(\"/stakeholders\");\n}\n\nexport async function updateStakeholder(\n  prevState: StakeholderFormState,\n  formData: FormData\n): Promise<StakeholderFormState> {\n  const id = formData.get(\"id\") as string;\n  \n  const validatedFields = stakeholderSchema.safeParse({\n    name: formData.get(\"name\"),\n    email: formData.get(\"email\"),\n    type: formData.get(\"type\"),\n    title: formData.get(\"title\") || undefined,\n  });\n\n  if (!validatedFields.success) {\n    return { errors: validatedFields.error.flatten().fieldErrors };\n  }\n\n  const { name, email, type, title } = validatedFields.data;\n\n  try {\n    const stakeholder = await prisma.stakeholder.findUnique({\n      where: { id },\n    });\n\n    if (!stakeholder) {\n      return { errors: { _form: [\"Stakeholder not found\"] } };\n    }\n\n    // Check if email is being changed and if new email already exists\n    if (email.toLowerCase() !== stakeholder.email.toLowerCase()) {\n      const existing = await prisma.stakeholder.findUnique({\n        where: {\n          companyId_email: {\n            companyId: stakeholder.companyId,\n            email: email.toLowerCase(),\n          },\n        },\n      });\n\n      if (existing) {\n        return { errors: { email: [\"A stakeholder with this email already exists\"] } };\n      }\n    }\n\n    await prisma.stakeholder.update({\n      where: { id },\n      data: {\n        name,\n        email: email.toLowerCase(),\n        type,\n        title: title || null,\n      },\n    });\n  } catch (error) {\n    console.error(\"Error updating stakeholder:\", error);\n    return { errors: { _form: [\"Failed to update stakeholder\"] } };\n  }\n\n  revalidatePath(\"/stakeholders\");\n  revalidatePath(`/stakeholders/${id}`);\n  redirect(\"/stakeholders\");\n}\n\nexport async function deleteStakeholder(id: string): Promise<{ error?: string }> {\n  try {\n    // Check if stakeholder has any securities\n    const stakeholder = await prisma.stakeholder.findUnique({\n      where: { id },\n      include: {\n        _count: {\n          select: {\n            shareCertificates: true,\n            optionGrants: true,\n            convertibles: true,\n          },\n        },\n      },\n    });\n\n    if (!stakeholder) {\n      return { error: \"Stakeholder not found\" };\n    }\n\n    const totalSecurities =\n      stakeholder._count.shareCertificates +\n      stakeholder._count.optionGrants +\n      stakeholder._count.convertibles;\n\n    if (totalSecurities > 0) {\n      return {\n        error: `Cannot delete stakeholder with existing securities (${totalSecurities} total)`,\n      };\n    }\n\n    await prisma.stakeholder.delete({\n      where: { id },\n    });\n\n    revalidatePath(\"/stakeholders\");\n    return {};\n  } catch (error) {\n    console.error(\"Error deleting stakeholder:\", error);\n    return { error: \"Failed to delete stakeholder\" };\n  }\n}\n","export {createStakeholder as '60052f4015a36bcdcded7a564a728882354e5a3e6d'} from 'ACTIONS_MODULE0'\nexport {updateStakeholder as '607ec0d706f006711626daf81fbfc131e2a247a5f0'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":"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"}