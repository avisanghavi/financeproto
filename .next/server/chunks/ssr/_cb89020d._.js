module.exports=[2533,a=>a.a(async(b,c)=>{try{var d=a.i(66518),e=a.i(19311),f=b([d,e]);async function g(a,b,c,f){await d.prisma.vestingPeriod.deleteMany({where:{vestingScheduleId:a}});let g=(0,e.generateVestingPeriods)(b,c,f);return await d.prisma.vestingPeriod.createManyAndReturn({data:g.map(b=>({vestingScheduleId:a,periodNumber:b.periodNumber,vestingDate:b.vestingDate,sharesVested:b.sharesVested,cumulativeVested:b.cumulativeVested}))})}async function h(a,b=new Date){let c=await d.prisma.optionGrant.findUnique({where:{id:a},include:{vestingSchedule:{include:{vestingPeriods:{orderBy:{periodNumber:"asc"}}}},exercises:{where:{status:{in:["APPROVED","COMPLETED"]}}}}});if(!c)return{totalShares:0,vestedShares:0,unvestedShares:0,exercisedShares:0,exercisableShares:0,vestedPercent:0,exercisedPercent:0};let e=c.originalQuantity-c.expiredQuantity,f=c.exercises.reduce((a,b)=>a+b.sharesExercised,0),g=0;if(c.vestingSchedule)for(let a of c.vestingSchedule.vestingPeriods)new Date(a.vestingDate)<=b&&(g=a.cumulativeVested);let i=e-g,j=Math.max(0,g-f);return{totalShares:e,vestedShares:g,unvestedShares:i,exercisedShares:f,exercisableShares:j,vestedPercent:e>0?g/e:0,exercisedPercent:e>0?f/e:0}}async function i(a,b=new Date){let c=await d.prisma.optionGrant.findUnique({where:{id:a},include:{vestingSchedule:{include:{vestingPeriods:{orderBy:{periodNumber:"asc"}}}}}});return c?.vestingSchedule?c.vestingSchedule.vestingPeriods.map(a=>{let c=new Date(a.vestingDate);return{periodNumber:a.periodNumber,vestingDate:c,sharesVested:a.sharesVested,cumulativeVested:a.cumulativeVested,isVested:c<=b,isPast:c<b}}):[]}[d,e]=f.then?(await f)():f,a.s(["createVestingPeriodRecords",()=>g,"getVestingPeriodsWithStatus",()=>i,"getVestingProgress",()=>h]),c()}catch(a){c(a)}},!1),24686,a=>a.a(async(b,c)=>{try{var d=a.i(66518),e=b([d]);async function f(a,b){let c=0;switch(a){case"CS":{let a=await d.prisma.shareCertificate.findFirst({where:{companyId:b},orderBy:{securityId:"desc"},select:{securityId:!0}});if(a){let b=parseInt(a.securityId.replace("CS-",""),10);isNaN(b)||(c=b)}break}case"ES":{let a=await d.prisma.optionGrant.findFirst({where:{companyId:b},orderBy:{securityId:"desc"},select:{securityId:!0}});if(a){let b=parseInt(a.securityId.replace("ES-",""),10);isNaN(b)||(c=b)}break}case"SAFE":{let a=await d.prisma.convertible.findFirst({where:{companyId:b,type:"SAFE"},orderBy:{securityId:"desc"},select:{securityId:!0}});if(a){let b=parseInt(a.securityId.replace("SAFE-",""),10);isNaN(b)||(c=b)}break}case"CN":{let a=await d.prisma.convertible.findFirst({where:{companyId:b,type:"CONVERTIBLE_NOTE"},orderBy:{securityId:"desc"},select:{securityId:!0}});if(a){let b=parseInt(a.securityId.replace("CN-",""),10);isNaN(b)||(c=b)}}}let e=c+1;return`${a}-${e.toString().padStart(2,"0")}`}[d]=e.then?(await e)():e,a.s(["generateSecurityId",()=>f]),c()}catch(a){c(a)}},!1),67419,a=>a.a(async(b,c)=>{try{var d=a.i(37936),e=a.i(66518),f=a.i(24686),g=a.i(2533),h=a.i(18558);a.i(70396);var i=a.i(73727),j=a.i(53112),k=a.i(13095),l=b([e,f,g]);[e,f,g]=l.then?(await l)():l;let o=j.z.object({stakeholderId:j.z.string().min(1,"Stakeholder is required"),equityPlanId:j.z.string().min(1,"Equity plan is required"),originalQuantity:j.z.coerce.number().int().positive("Quantity must be positive"),exercisePrice:j.z.coerce.number().positive("Exercise price must be positive"),type:j.z.enum(["ISO","NSO"]),grantDate:j.z.string().min(1,"Grant date is required"),boardApprovalDate:j.z.string().optional(),expirationDate:j.z.string().min(1,"Expiration date is required"),grantReason:j.z.string().optional(),status:j.z.enum(["ACTIVE","PARTIALLY_EXERCISED","FULLY_EXERCISED","EXPIRED","CANCELLED","TERMINATED"]).default("ACTIVE"),vestingStartDate:j.z.string().min(1,"Vesting start date is required"),cliffMonths:j.z.coerce.number().int().min(0).default(12),cliffPercentage:j.z.coerce.number().min(0).max(1).default(.25),totalPeriods:j.z.coerce.number().int().positive().default(48),periodUnit:j.z.enum(["MONTHLY","QUARTERLY","ANNUALLY"]).default("MONTHLY"),scheduleName:j.z.string().optional()});async function m(a,b){let c=await e.prisma.company.findFirst();if(!c)return{errors:{_form:["No company found"]}};let d=o.safeParse({stakeholderId:b.get("stakeholderId"),equityPlanId:b.get("equityPlanId"),originalQuantity:b.get("originalQuantity"),exercisePrice:b.get("exercisePrice"),type:b.get("type"),grantDate:b.get("grantDate"),boardApprovalDate:b.get("boardApprovalDate"),expirationDate:b.get("expirationDate"),grantReason:b.get("grantReason"),status:b.get("status")||"ACTIVE",vestingStartDate:b.get("vestingStartDate"),cliffMonths:b.get("cliffMonths"),cliffPercentage:parseFloat(b.get("cliffPercentage"))||.25,totalPeriods:b.get("totalPeriods"),periodUnit:b.get("periodUnit"),scheduleName:b.get("scheduleName")});if(!d.success)return{errors:d.error.flatten().fieldErrors};let j=d.data,k=await e.prisma.equityPlan.findUnique({where:{id:j.equityPlanId}});if(!k)return{errors:{_form:["Equity plan not found"]}};if(k.availableShares<j.originalQuantity)return{errors:{originalQuantity:[`Not enough shares in pool. Available: ${k.availableShares.toLocaleString()}`]}};try{let a=await (0,f.generateSecurityId)("ES",c.id),b=await e.prisma.$transaction(async b=>{let d=await b.optionGrant.create({data:{companyId:c.id,securityId:a,stakeholderId:j.stakeholderId,equityPlanId:j.equityPlanId,originalQuantity:j.originalQuantity,exercisePrice:j.exercisePrice,type:j.type,grantDate:new Date(j.grantDate),boardApprovalDate:j.boardApprovalDate?new Date(j.boardApprovalDate):null,expirationDate:new Date(j.expirationDate),grantReason:j.grantReason||null,status:j.status}}),e=await b.vestingSchedule.create({data:{optionGrantId:d.id,scheduleName:j.scheduleName||null,vestingStartDate:new Date(j.vestingStartDate),cliffMonths:j.cliffMonths,cliffPercentage:j.cliffPercentage,totalPeriods:j.totalPeriods,periodUnit:j.periodUnit}});return await b.equityPlan.update({where:{id:j.equityPlanId},data:{availableShares:{decrement:j.originalQuantity}}}),await b.postTerminationExercisePeriod.createMany({data:[{optionGrantId:d.id,terminationType:"VOLUNTARY",duration:90,durationUnit:"DAYS"},{optionGrantId:d.id,terminationType:"INVOLUNTARY",duration:90,durationUnit:"DAYS"},{optionGrantId:d.id,terminationType:"FOR_CAUSE",duration:0,durationUnit:"DAYS"},{optionGrantId:d.id,terminationType:"DEATH",duration:12,durationUnit:"MONTHS"},{optionGrantId:d.id,terminationType:"DISABILITY",duration:12,durationUnit:"MONTHS"},{optionGrantId:d.id,terminationType:"RETIREMENT",duration:3,durationUnit:"MONTHS"}]}),{grant:d,vestingSchedule:e}});await (0,g.createVestingPeriodRecords)(b.vestingSchedule.id,j.originalQuantity,{vestingStartDate:new Date(j.vestingStartDate),cliffMonths:j.cliffMonths,cliffPercentage:j.cliffPercentage,totalPeriods:j.totalPeriods,periodUnit:j.periodUnit}),await e.prisma.auditLog.create({data:{companyId:c.id,action:"CREATE",entityType:"OptionGrant",entityId:b.grant.id,after:b.grant}}),(0,h.revalidatePath)("/options"),(0,h.revalidatePath)("/cap-table"),(0,h.revalidatePath)("/")}catch(a){return console.error("Error creating option grant:",a),{errors:{_form:["Failed to create option grant"]}}}(0,i.redirect)("/options")}async function n(a,b){let c=await e.prisma.optionGrant.findUnique({where:{id:a},include:{vestingSchedule:{include:{vestingPeriods:!0}},exercises:{where:{status:{in:["APPROVED","COMPLETED"]}}},stakeholder:!0,equityPlan:!0}});if(!c)return{error:"Grant not found"};let d=parseInt(b.get("sharesToExercise"),10),g=b.get("paymentMethod"),j=parseFloat(b.get("fmvAtExercise"));if(!d||d<=0)return{error:"Invalid number of shares"};let k=new Date,l=0;if(c.vestingSchedule)for(let a of c.vestingSchedule.vestingPeriods)new Date(a.vestingDate)<=k&&(l=a.cumulativeVested);let m=c.exercises.reduce((a,b)=>a+b.sharesExercised,0),n=l-m;if(d>n)return{error:`Cannot exercise more than ${n.toLocaleString()} shares`};try{let b=await e.prisma.shareClass.findFirst({where:{companyId:c.companyId,type:"COMMON"}});if(!b)return{error:"No common share class found"};let i=await (0,f.generateSecurityId)("CS",c.companyId),l=d*Number(c.exercisePrice);await e.prisma.$transaction(async e=>{let f=await e.shareCertificate.create({data:{companyId:c.companyId,securityId:i,stakeholderId:c.stakeholderId,shareClassId:b.id,quantity:d,pricePerShare:c.exercisePrice,cashPaid:l,costBasis:l,acquisitionDate:k,issueDate:k,status:"OUTSTANDING"}});await e.optionExercise.create({data:{optionGrantId:a,shareCertificateId:f.id,sharesExercised:d,exercisePrice:c.exercisePrice,totalCost:l,exerciseDate:k,fmvAtExercise:j,paymentMethod:g,status:"COMPLETED",approvedAt:k}});let h=m+d>=c.originalQuantity-c.expiredQuantity?"FULLY_EXERCISED":"PARTIALLY_EXERCISED";await e.optionGrant.update({where:{id:a},data:{status:h}})}),await e.prisma.auditLog.create({data:{companyId:c.companyId,action:"EXERCISE",entityType:"OptionGrant",entityId:a,after:{sharesToExercise:d,paymentMethod:g,fmvAtExercise:j}}}),(0,h.revalidatePath)("/options"),(0,h.revalidatePath)(`/options/${a}`),(0,h.revalidatePath)("/certificates"),(0,h.revalidatePath)("/cap-table"),(0,h.revalidatePath)("/")}catch(a){return console.error("Error exercising options:",a),{error:"Failed to exercise options"}}(0,i.redirect)(`/options/${a}`)}(0,k.ensureServerEntryExports)([m,n]),(0,d.registerServerReference)(m,"60044db7427d22521822256a6d3a656c9b2b5799f0",null),(0,d.registerServerReference)(n,"604fcde696349a20ca4fc853a4574eebb149fe5099",null),a.s(["createOptionGrant",()=>m,"exerciseOptions",()=>n]),c()}catch(a){c(a)}},!1),90657,a=>a.a(async(b,c)=>{try{var d=a.i(67419),e=b([d]);[d]=e.then?(await e)():e,a.s([]),c()}catch(a){c(a)}},!1),51711,a=>a.a(async(b,c)=>{try{var d=a.i(90657),e=a.i(67419),f=b([d,e]);[d,e]=f.then?(await f)():f,a.s(["604fcde696349a20ca4fc853a4574eebb149fe5099",()=>e.exerciseOptions]),c()}catch(a){c(a)}},!1)];

//# sourceMappingURL=_cb89020d._.js.map