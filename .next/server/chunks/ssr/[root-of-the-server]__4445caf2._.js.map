{"version":3,"sources":["../../../../src/lib/security-id.ts","../../../../src/app/%28admin%29/certificates/actions.ts","../../../../.next-internal/server/app/%28admin%29/certificates/new/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["import { prisma } from \"./prisma\";\n\nexport type SecurityIdPrefix = \"CS\" | \"ES\" | \"SAFE\" | \"CN\";\n\n/**\n * Generates a unique security ID with the given prefix.\n * Format: PREFIX-XX (e.g., CS-01, ES-12, SAFE-03, CN-01)\n */\nexport async function generateSecurityId(\n  prefix: SecurityIdPrefix,\n  companyId: string\n): Promise<string> {\n  let maxNumber = 0;\n\n  switch (prefix) {\n    case \"CS\": {\n      const lastCert = await prisma.shareCertificate.findFirst({\n        where: { companyId },\n        orderBy: { securityId: \"desc\" },\n        select: { securityId: true },\n      });\n      if (lastCert) {\n        const num = parseInt(lastCert.securityId.replace(\"CS-\", \"\"), 10);\n        if (!isNaN(num)) maxNumber = num;\n      }\n      break;\n    }\n    case \"ES\": {\n      const lastGrant = await prisma.optionGrant.findFirst({\n        where: { companyId },\n        orderBy: { securityId: \"desc\" },\n        select: { securityId: true },\n      });\n      if (lastGrant) {\n        const num = parseInt(lastGrant.securityId.replace(\"ES-\", \"\"), 10);\n        if (!isNaN(num)) maxNumber = num;\n      }\n      break;\n    }\n    case \"SAFE\": {\n      const lastSafe = await prisma.convertible.findFirst({\n        where: { companyId, type: \"SAFE\" },\n        orderBy: { securityId: \"desc\" },\n        select: { securityId: true },\n      });\n      if (lastSafe) {\n        const num = parseInt(lastSafe.securityId.replace(\"SAFE-\", \"\"), 10);\n        if (!isNaN(num)) maxNumber = num;\n      }\n      break;\n    }\n    case \"CN\": {\n      const lastCN = await prisma.convertible.findFirst({\n        where: { companyId, type: \"CONVERTIBLE_NOTE\" },\n        orderBy: { securityId: \"desc\" },\n        select: { securityId: true },\n      });\n      if (lastCN) {\n        const num = parseInt(lastCN.securityId.replace(\"CN-\", \"\"), 10);\n        if (!isNaN(num)) maxNumber = num;\n      }\n      break;\n    }\n  }\n\n  const nextNumber = maxNumber + 1;\n  return `${prefix}-${nextNumber.toString().padStart(2, \"0\")}`;\n}\n\n/**\n * Parses a security ID and returns the prefix and number.\n */\nexport function parseSecurityId(securityId: string): {\n  prefix: SecurityIdPrefix;\n  number: number;\n} | null {\n  const match = securityId.match(/^(CS|ES|SAFE|CN)-(\\d+)$/);\n  if (!match) return null;\n  return {\n    prefix: match[1] as SecurityIdPrefix,\n    number: parseInt(match[2], 10),\n  };\n}\n","\"use server\";\n\nimport { prisma } from \"@/lib/prisma\";\nimport { generateSecurityId } from \"@/lib/security-id\";\nimport { revalidatePath } from \"next/cache\";\nimport { redirect } from \"next/navigation\";\nimport { z } from \"zod\";\n\nconst certificateSchema = z.object({\n  stakeholderId: z.string().min(1, \"Stakeholder is required\"),\n  shareClassId: z.string().min(1, \"Share class is required\"),\n  quantity: z.coerce.number().int().positive(\"Quantity must be positive\"),\n  pricePerShare: z.coerce.number().positive(\"Price must be positive\"),\n  cashPaid: z.coerce.number().min(0, \"Cash paid cannot be negative\"),\n  costBasis: z.coerce.number().min(0).optional(),\n  acquisitionDate: z.string().min(1, \"Acquisition date is required\"),\n  issueDate: z.string().optional(),\n  originalIssueDate: z.string().optional(),\n  status: z.enum([\"OUTSTANDING\", \"CANCELLED\", \"TRANSFERRED\", \"REPURCHASED\"]).default(\"OUTSTANDING\"),\n});\n\nexport type CertificateFormState = {\n  errors?: {\n    stakeholderId?: string[];\n    shareClassId?: string[];\n    quantity?: string[];\n    pricePerShare?: string[];\n    cashPaid?: string[];\n    costBasis?: string[];\n    acquisitionDate?: string[];\n    issueDate?: string[];\n    status?: string[];\n    _form?: string[];\n  };\n  message?: string;\n};\n\nexport async function createCertificate(\n  prevState: CertificateFormState,\n  formData: FormData\n): Promise<CertificateFormState> {\n  const company = await prisma.company.findFirst();\n  if (!company) {\n    return { errors: { _form: [\"No company found\"] } };\n  }\n\n  const validatedFields = certificateSchema.safeParse({\n    stakeholderId: formData.get(\"stakeholderId\"),\n    shareClassId: formData.get(\"shareClassId\"),\n    quantity: formData.get(\"quantity\"),\n    pricePerShare: formData.get(\"pricePerShare\"),\n    cashPaid: formData.get(\"cashPaid\"),\n    costBasis: formData.get(\"costBasis\") || formData.get(\"cashPaid\"),\n    acquisitionDate: formData.get(\"acquisitionDate\"),\n    issueDate: formData.get(\"issueDate\"),\n    originalIssueDate: formData.get(\"originalIssueDate\"),\n    status: formData.get(\"status\") || \"OUTSTANDING\",\n  });\n\n  if (!validatedFields.success) {\n    return {\n      errors: validatedFields.error.flatten().fieldErrors,\n    };\n  }\n\n  const data = validatedFields.data;\n\n  try {\n    // Generate security ID\n    const securityId = await generateSecurityId(\"CS\", company.id);\n\n    // Create certificate\n    const certificate = await prisma.shareCertificate.create({\n      data: {\n        companyId: company.id,\n        securityId,\n        stakeholderId: data.stakeholderId,\n        shareClassId: data.shareClassId,\n        quantity: data.quantity,\n        pricePerShare: data.pricePerShare,\n        cashPaid: data.cashPaid,\n        costBasis: data.costBasis ?? data.cashPaid,\n        acquisitionDate: new Date(data.acquisitionDate),\n        issueDate: data.issueDate ? new Date(data.issueDate) : new Date(),\n        originalIssueDate: data.originalIssueDate\n          ? new Date(data.originalIssueDate)\n          : null,\n        status: data.status,\n      },\n    });\n\n    // Create audit log\n    await prisma.auditLog.create({\n      data: {\n        companyId: company.id,\n        action: \"CREATE\",\n        entityType: \"ShareCertificate\",\n        entityId: certificate.id,\n        after: certificate as any,\n      },\n    });\n\n    revalidatePath(\"/certificates\");\n    revalidatePath(\"/cap-table\");\n    revalidatePath(\"/\");\n  } catch (error) {\n    console.error(\"Error creating certificate:\", error);\n    return { errors: { _form: [\"Failed to create certificate\"] } };\n  }\n\n  redirect(\"/certificates\");\n}\n\nexport async function updateCertificate(\n  id: string,\n  prevState: CertificateFormState,\n  formData: FormData\n): Promise<CertificateFormState> {\n  const existing = await prisma.shareCertificate.findUnique({\n    where: { id },\n  });\n\n  if (!existing) {\n    return { errors: { _form: [\"Certificate not found\"] } };\n  }\n\n  const validatedFields = certificateSchema.safeParse({\n    stakeholderId: formData.get(\"stakeholderId\"),\n    shareClassId: formData.get(\"shareClassId\"),\n    quantity: formData.get(\"quantity\"),\n    pricePerShare: formData.get(\"pricePerShare\"),\n    cashPaid: formData.get(\"cashPaid\"),\n    costBasis: formData.get(\"costBasis\") || formData.get(\"cashPaid\"),\n    acquisitionDate: formData.get(\"acquisitionDate\"),\n    issueDate: formData.get(\"issueDate\"),\n    originalIssueDate: formData.get(\"originalIssueDate\"),\n    status: formData.get(\"status\") || \"OUTSTANDING\",\n  });\n\n  if (!validatedFields.success) {\n    return {\n      errors: validatedFields.error.flatten().fieldErrors,\n    };\n  }\n\n  const data = validatedFields.data;\n\n  try {\n    const certificate = await prisma.shareCertificate.update({\n      where: { id },\n      data: {\n        stakeholderId: data.stakeholderId,\n        shareClassId: data.shareClassId,\n        quantity: data.quantity,\n        pricePerShare: data.pricePerShare,\n        cashPaid: data.cashPaid,\n        costBasis: data.costBasis ?? data.cashPaid,\n        acquisitionDate: new Date(data.acquisitionDate),\n        issueDate: data.issueDate ? new Date(data.issueDate) : undefined,\n        originalIssueDate: data.originalIssueDate\n          ? new Date(data.originalIssueDate)\n          : null,\n        status: data.status,\n      },\n    });\n\n    // Create audit log\n    await prisma.auditLog.create({\n      data: {\n        companyId: existing.companyId,\n        action: \"UPDATE\",\n        entityType: \"ShareCertificate\",\n        entityId: certificate.id,\n        before: existing as any,\n        after: certificate as any,\n      },\n    });\n\n    revalidatePath(\"/certificates\");\n    revalidatePath(`/certificates/${id}`);\n    revalidatePath(\"/cap-table\");\n    revalidatePath(\"/\");\n  } catch (error) {\n    console.error(\"Error updating certificate:\", error);\n    return { errors: { _form: [\"Failed to update certificate\"] } };\n  }\n\n  redirect(`/certificates/${id}`);\n}\n\nexport async function deleteCertificate(id: string) {\n  const existing = await prisma.shareCertificate.findUnique({\n    where: { id },\n  });\n\n  if (!existing) {\n    throw new Error(\"Certificate not found\");\n  }\n\n  // Soft delete by changing status to CANCELLED\n  await prisma.shareCertificate.update({\n    where: { id },\n    data: { status: \"CANCELLED\" },\n  });\n\n  // Create audit log\n  await prisma.auditLog.create({\n    data: {\n      companyId: existing.companyId,\n      action: \"DELETE\",\n      entityType: \"ShareCertificate\",\n      entityId: id,\n      before: existing as any,\n    },\n  });\n\n  revalidatePath(\"/certificates\");\n  revalidatePath(\"/cap-table\");\n  revalidatePath(\"/\");\n}\n","export {createCertificate as '6093ad5c5e46858a83c3fc7f610335cdcc40c3e712'} from 'ACTIONS_MODULE0'\nexport {updateCertificate as '70431018d6fb193461e63524788a3220b5da11ca4b'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":"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"}